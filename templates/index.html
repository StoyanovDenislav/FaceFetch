<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Facial Recognition System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }

      .subtitle {
        font-size: 1.1em;
        opacity: 0.9;
      }

      .main-content {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
      }

      @media (max-width: 1024px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }

      .video-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .video-wrapper {
        position: relative;
        width: 100%;
        background: #000;
        border-radius: 10px;
        overflow: hidden;
      }

      #videoFeed {
        width: 100%;
        height: auto;
        display: block;
      }

      .stats-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .stats-container h2 {
        color: #667eea;
        margin-bottom: 20px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
      }

      .stat-item {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
      }

      .stat-label {
        font-weight: bold;
        color: #555;
        margin-bottom: 5px;
      }

      .stat-value {
        font-size: 1.2em;
        color: #333;
      }

      .detection-panel {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      }

      .detection-panel h2 {
        color: #667eea;
        margin-bottom: 20px;
        border-bottom: 3px solid #667eea;
        padding-bottom: 10px;
      }

      .face-card {
        background: #f8f9fa;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 8px;
        border-left: 4px solid #28a745;
      }

      .face-card.unknown {
        border-left-color: #ffc107;
      }

      .face-card.spoof {
        border-left-color: #dc3545;
      }

      .face-card.pending {
        border-left-color: #17a2b8;
      }

      .face-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .face-name {
        font-weight: bold;
        font-size: 1.1em;
        color: #333;
      }

      .face-badge {
        padding: 5px 10px;
        border-radius: 20px;
        font-size: 0.8em;
        font-weight: bold;
        text-transform: uppercase;
      }

      .badge-known {
        background: #28a745;
        color: white;
      }

      .badge-unknown {
        background: #ffc107;
        color: #333;
      }

      .badge-spoof {
        background: #dc3545;
        color: white;
      }

      .badge-pending {
        background: #17a2b8;
        color: white;
      }

      .face-details {
        font-size: 0.9em;
        color: #666;
        line-height: 1.6;
      }

      .live-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .live-indicator.live {
        background: #28a745;
        box-shadow: 0 0 5px #28a745;
      }

      .live-indicator.not-live {
        background: #dc3545;
      }

      .no-faces {
        text-align: center;
        color: #999;
        padding: 40px;
        font-size: 1.1em;
      }

      .history-item {
        background: #f8f9fa;
        padding: 12px;
        margin-bottom: 10px;
        border-radius: 8px;
        border-left: 4px solid #667eea;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
      }

      .history-item.spoof {
        border-left-color: #dc3545;
      }

      .history-item.known {
        border-left-color: #28a745;
      }

      .history-item.unknown {
        border-left-color: #ffc107;
      }

      .history-time {
        font-size: 0.85em;
        color: #666;
        margin-bottom: 3px;
      }

      .history-name {
        font-weight: bold;
        color: #333;
      }

      .api-info {
        background: white;
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        margin-top: 20px;
      }

      .api-info h2 {
        color: #667eea;
        margin-bottom: 15px;
      }

      .api-endpoint {
        background: #f8f9fa;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
        font-family: "Courier New", monospace;
        font-size: 0.9em;
      }

      .refresh-status {
        text-align: center;
        color: white;
        margin-top: 10px;
        font-size: 0.9em;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>ðŸ”’ Facial Recognition System</h1>
        <p class="subtitle">Real-time Face Detection & Anti-Spoofing</p>
      </header>

      <div class="main-content">
        <div class="video-container">
          <h2 style="color: #667eea; margin-bottom: 15px">
            ðŸ“¹ Live Camera Feed
          </h2>
          <div class="video-wrapper">
            <img
              id="videoFeed"
              src="{{ url_for('video_feed') }}"
              alt="Video Feed"
            />
          </div>
        </div>

        <div class="stats-container">
          <h2>ðŸ“Š System Status</h2>
          <div class="stat-item">
            <div class="stat-label">Camera Type</div>
            <div class="stat-value" id="cameraType">Loading...</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Known Faces</div>
            <div class="stat-value" id="knownFaces">Loading...</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Active Detections</div>
            <div class="stat-value" id="totalFaces">0</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">Last Update</div>
            <div class="stat-value" id="lastUpdate">Never</div>
          </div>
        </div>
      </div>

      <div class="detection-panel">
        <h2>ðŸ‘¥ Detected Faces</h2>
        <div id="facesContainer">
          <div class="no-faces">No faces detected</div>
        </div>
      </div>

      <div class="detection-panel">
        <h2>
          ðŸ“œ Detection History
          <button
            id="clearHistory"
            style="
              float: right;
              padding: 5px 15px;
              background: #dc3545;
              color: white;
              border: none;
              border-radius: 5px;
              cursor: pointer;
            "
          >
            Clear History
          </button>
        </h2>
        <div id="historyContainer">
          <div class="no-faces">No history yet</div>
        </div>
      </div>

      <div class="api-info">
        <h2>ðŸ”Œ API Endpoints</h2>
        <p>Access detection data programmatically:</p>
        <div class="api-endpoint">
          GET /api/detections - Get current detection results (JSON)
        </div>
        <div class="api-endpoint">
          GET /api/status - Get system status (JSON)
        </div>
      </div>

      <div class="detection-panel">
        <h2>ðŸ“„ Raw JSON Data</h2>
        <pre
          id="jsonData"
          style="
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
          "
        >
Loading...</pre
        >
      </div>

      <div class="refresh-status">
        Auto-refreshing every second â€¢
        <span id="connectionStatus">Connected</span>
      </div>
    </div>

    <script>
      let lastTimestamp = 0;

      async function updateDetections() {
        try {
          const response = await fetch("/api/detections");
          const data = await response.json();

          // Update total faces
          document.getElementById("totalFaces").textContent = data.total_faces;

          // Update last update time
          const now = new Date(data.timestamp * 1000);
          document.getElementById("lastUpdate").textContent =
            now.toLocaleTimeString();

          // Update faces display
          const container = document.getElementById("facesContainer");

          if (data.total_faces === 0) {
            container.innerHTML =
              '<div class="no-faces">No faces detected</div>';
          } else {
            container.innerHTML = "";

            data.faces.forEach((face, index) => {
              const faceCard = document.createElement("div");
              faceCard.className = `face-card ${face.state}`;

              const badgeClass =
                face.state === "known"
                  ? "badge-known"
                  : face.state === "unknown"
                  ? "badge-unknown"
                  : face.state === "spoof"
                  ? "badge-spoof"
                  : "badge-pending";

              const liveClass = face.is_live ? "live" : "not-live";
              const liveText = face.is_live ? "Live" : "Not Live";

              faceCard.innerHTML = `
                            <div class="face-header">
                                <div class="face-name">Face #${index + 1}</div>
                                <span class="face-badge ${badgeClass}">${
                face.state
              }</span>
                            </div>
                            <div class="face-details">
                                <strong>Name:</strong> ${
                                  face.name || "Unknown"
                                }<br>
                                ${
                                  face.confidence
                                    ? `<strong>Confidence:</strong> ${face.confidence}<br>`
                                    : ""
                                }
                                <strong>Status:</strong> <span class="live-indicator ${liveClass}"></span>${liveText}<br>
                                <strong>Location:</strong> Top: ${
                                  face.location.top
                                }, Left: ${face.location.left}
                            </div>
                        `;

              container.appendChild(faceCard);
            });
          }

          document.getElementById("connectionStatus").textContent = "Connected";
          document.getElementById("connectionStatus").style.color = "#28a745";

          // Update JSON display
          document.getElementById("jsonData").textContent = JSON.stringify(
            data,
            null,
            2
          );
        } catch (error) {
          console.error("Error fetching detections:", error);
          document.getElementById("connectionStatus").textContent =
            "Disconnected";
          document.getElementById("connectionStatus").style.color = "#dc3545";
        }
      }

      async function updateSystemStatus() {
        try {
          const response = await fetch("/api/status");
          const data = await response.json();

          document.getElementById("cameraType").textContent = data.camera_type;
          document.getElementById("knownFaces").textContent =
            data.known_faces + " (" + data.faces_loaded.join(", ") + ")";
        } catch (error) {
          console.error("Error fetching system status:", error);
        }
      }

      async function updateHistory() {
        try {
          const response = await fetch("/api/history");
          const data = await response.json();

          const container = document.getElementById("historyContainer");

          if (data.total_entries === 0) {
            container.innerHTML = '<div class="no-faces">No history yet</div>';
          } else {
            container.innerHTML = "";

            // Show last 20 entries
            data.history.slice(0, 20).forEach((entry) => {
              const historyItem = document.createElement("div");
              historyItem.className = `history-item ${entry.state}`;

              const date = new Date(entry.timestamp * 1000);
              const timeString = date.toLocaleTimeString();

              historyItem.innerHTML = `
                            <div>
                                <div class="history-time">${timeString}</div>
                                <div class="history-name">${
                                  entry.name || "Unknown"
                                }</div>
                            </div>
                            <div>
                                <span class="face-badge badge-${entry.state}">${
                entry.state
              }</span>
                            </div>
                        `;

              container.appendChild(historyItem);
            });
          }
        } catch (error) {
          console.error("Error fetching history:", error);
        }
      }

      // Clear history button
      document
        .getElementById("clearHistory")
        .addEventListener("click", async () => {
          try {
            await fetch("/api/history/clear", { method: "POST" });
            updateHistory();
          } catch (error) {
            console.error("Error clearing history:", error);
          }
        });

      // Update detections every second
      setInterval(updateDetections, 1000);

      // Update history every 2 seconds
      setInterval(updateHistory, 2000);

      // Update system status every 10 seconds
      setInterval(updateSystemStatus, 10000);

      // Initial load
      updateDetections();
      updateSystemStatus();
      updateHistory();
    </script>
  </body>
</html>
